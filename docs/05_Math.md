# 5. 수학적 원리: 하이브리드 역전파와 상태-전이 미분

## 5.1. 개요

본 패러다임의 학습 과정은, 1장에서 정의한 이중-코어 파라미터의 이질적인(heterogeneous) 특성에 맞춰 설계된 **하이브리드 역전파(Hybrid Backpropagation)** 알고리즘에 기반한다. 표준적인 역전파 알고리즘이 모든 파라미터를 동종의 연속적인 실수로 가정하는 것과 달리, 하이브리드 역전파는 다음과 같은 두 종류의 그래디언트를 동시에, 각기 다른 방식으로 계산한다.

1.  **연속계 그래디언트 (Continuous-Domain Gradient)**: `seed.lo` 필드와 `residuals` 계수와 같은 연속 파라미터에 대한 표준적인 미분.
2.  **상태-전이 그래디언트 (State-Transition Gradient)**: `seed.hi` 필드의 이산적인 상태 공간(discrete state space)에 대한 미분을 '최적의 인접 상태로의 전이'로 재해석한 새로운 개념의 미분.

본 장에서는 이 두 가지 미분 방식의 수학적 원리를 상세히 기술하고, 특히 상태-전이 미분이 어떻게 계산되는지를 구체적인 수치 예제를 통해 증명한다.

## 5.2. 역전파의 목표

역전파의 최종 목표는 손실 함수 L에 대한 전체 가중치 행렬의 그래디언트 `∂L/∂W`가 주어졌을 때, 체인 룰(Chain Rule)에 따라 우리가 실제로 저장하고 있는 파라미터들에 대한 그래디언트를 구하는 것이다.
- `∂L/∂(seed.lo)`
- `∂L/∂(residuals)`
- `∂L/∂(seed.hi)`

## 5.3. 연속계 그래디언트 계산

`seed.lo`와 `residuals`는 모두 연속적인 실수 값으로 구성되므로, 이들에 대한 그래디언트는 표준적인 체인 룰을 통해 해석적으로(analytically) 계산된다.

### 5.3.1. `∂L/∂(seed.lo)` 계산

`seed.lo`는 `r_fp32`와 `theta_fp32` 두 실수로 구성된다. `r_fp32`에 대한 그래디언트를 예로 들면 다음과 같다.
\[ \frac{\partial L}{\partial r_{fp32}} = \sum_{i,j} \frac{\partial L}{\partial W_{ij}} \frac{\partial W_{ij}}{\partial r_{fp32}} \]
여기서 `∂W_ij/∂r_fp32`는 3장에서 정의한 `F_continuous` 함수를 `r_fp32`에 대해 편미분한 값이다. 이 값은 해석적으로 유도 가능하며, 전체 그래디언트는 `∂L/∂W` 행렬과 `∂W/∂r_fp32` 행렬의 Frobenius 내적(Frobenius inner product)으로 효율적으로 계산할 수 있다. `theta_fp32`에 대해서도 동일한 원리가 적용된다.

### 5.3.2. `∂L/∂(residuals)` 계산

잔차 계수의 그래디언트는 `∂L/∂W`에 순방향 변환(forward transform)을 적용하여 구한다. 예를 들어, 잔차 보정에 DCT를 사용했다면, `k,l`번째 잔차 계수 `C_kl`에 대한 그래디언트는 다음과 같다.
\[ \frac{\partial L}{\partial C_{kl}} = \text{DCT} \left( \frac{\partial L}{\partial W} \right)_{kl} \]
즉, 가중치 그래디언트 행렬을 DCT 변환한 결과 행렬의 각 요소가 바로 해당 위치의 잔차 계수에 대한 그래디언트가 된다.

## 5.4. 상태-전이 미분: `∂L/∂(seed.hi)`의 재해석

`seed.hi`는 이산적인 비트 필드로 구성되어 있어 직접적인 미분이 불가능하다. 본 패러다임은 이 문제를 '미분'의 개념을 확장하여 해결한다.

### 5.4.1. 개념적 기반: 미분과 주기성

삼각함수는 주기적인 미분 관계를 가진다: `d/dx sin(x) = cos(x)`, `d/dx cos(x) = -sin(x)`. 이는 `sin` 함수의 미소 변화(infinitesimal change)가 `cos` 함수의 형태를 따른다는 의미이다.

우리는 이 개념을 이산 공간으로 확장한다. `hi` 필드의 `phase_state` 비트가 `00(sin)`일 때, 이 상태에 대한 '미분'은 다음 상태인 `01(cos)`로의 **전이(transition) 경향성**으로 정의한다. 즉, 그래디언트는 실수 값이 아니라, 상태를 변경해야 할 '압력(pressure)'으로 해석된다.

### 5.4.2. 상태 전이 압력 (State Transition Pressure)

'상태 전이 압력' `P`는, 현재 손실을 줄이기 위해 가중치 패턴이 다음 상태의 기저 함수와 얼마나 유사해져야 하는지를 나타내는 스칼라 값이다. 이는 가중치 그래디언트 `∂L/∂W`를 다음 상태의 기저 함수 행렬 `B_next`에 투영(projection)하여 계산한다.

\[ P = \langle \frac{\partial L}{\partial W}, B_{next} \rangle = \sum_{i,j} \frac{\partial L}{\partial W_{ij}} \cdot (B_{next})_{ij} \]
-   `P > 0`: `∂L/∂W`와 `B_next`가 같은 방향을 가리킨다. 즉, 패턴이 `B_next`와 비슷해지면 손실이 감소할 가능성이 높다.
-   `P < 0`: `∂L/∂W`와 `B_next`가 반대 방향을 가리킨다. 패턴이 `-B_next`와 비슷해져야 손실이 감소한다.

### 5.4.3. 그래디언트 기반 상태 업데이트 알고리즘

1.  역전파를 통해 가중치 그래디언트 `G_W = ∂L/∂W`를 계산한다.
2.  `hi` 필드에서 현재 `phase_state`를 읽어 현재 기저 함수 행렬 `B_current`를 식별한다 (예: `00` -> `B_sin`).
3.  주기성에 따라 다음 상태의 기저 함수 행렬 `B_next`를 식별한다 (예: `sin` -> `cos`, `B_cos`).
4.  상태 전이 압력 `P = <G_W, B_next>`를 계산한다.
5.  압력 `P`가 미리 정의된 임계값 `τ`를 초과하면, 상태 전이를 수행한다. 즉, `phase_state` 비트에 `+1`을 한다.
    -   `if P > τ`: `phase_state++` (예: `00(sin)` -> `01(cos)`)
    -   `if P < -τ`: `phase_state--` (주기성을 역으로 적용)

이 과정은 **Straight-Through Estimator (STE)**의 변형으로 볼 수 있다. 순전파 시에는 이산적인 `phase_state`를 사용하지만, 역전파 시에는 그래디언트가 이 상태 변경 로직을 '통과'하여 이전 레이어로 흐르도록 허용한다. 상태 업데이트 자체는 계산된 압력에 기반한 휴리스틱(heuristic)이다.

## 5.5. 수치 예제: 2x2 행렬의 상태-전이 미분

개념을 명확히 하기 위해, 2x2 행렬의 `phase_state`가 업데이트되는 전 과정을 실제 숫자로 계산한다.

-   **설정**:
    -   입력 `x = [1, 2]^T`, 타겟 `y_true = [5, 5]^T`
    -   손실 함수 `L = 0.5 * ||y_true - y_pred||²`
    -   현재 `hi`의 `phase_state` = `00` (즉, 기저 함수는 `sin`). 다른 파라미터는 단순화를 위해 생략, `W = B_sin`이라 가정.
    -   좌표 `(i,j)`에 대해 `sin` 기저 행렬 `B_sin`과 다음 상태 `cos` 기저 행렬 `B_cos`가 다음과 같이 주어졌다고 가정.
        \[ B_{sin} = \begin{pmatrix} 0.1 & 0.2 \\ 0.2 & 0.3 \end{pmatrix}, \quad B_{cos} = \begin{pmatrix} 0.4 & 0.5 \\ 0.5 & 0.6 \end{pmatrix} \]

1.  **순전파 (Forward Pass)**:
    -   `y_pred = W * x = B_sin * x`
        \[ \begin{pmatrix} 0.1 & 0.2 \\ 0.2 & 0.3 \end{pmatrix} \begin{pmatrix} 1 \\ 2 \end{pmatrix} = \begin{pmatrix} 0.1 \cdot 1 + 0.2 \cdot 2 \\ 0.2 \cdot 1 + 0.3 \cdot 2 \end{pmatrix} = \begin{pmatrix} 0.5 \\ 0.8 \end{pmatrix} \]
    -   `Error = y_true - y_pred = [4.5, 4.2]^T`
    -   `L = 0.5 * (4.5² + 4.2²) = 0.5 * (20.25 + 17.64) = 18.945`

2.  **역전파 (Backward Pass): `∂L/∂W` 계산**
    -   `∂L/∂y_pred = -(y_true - y_pred) = [-4.5, -4.2]^T`
    -   `∂L/∂W = (∂L/∂y_pred) * x^T` (외적, outer product)
        \[ \frac{\partial L}{\partial W} = \begin{pmatrix} -4.5 \\ -4.2 \end{pmatrix} \begin{pmatrix} 1 & 2 \end{pmatrix} = \begin{pmatrix} -4.5 \cdot 1 & -4.5 \cdot 2 \\ -4.2 \cdot 1 & -4.2 \cdot 2 \end{pmatrix} = \begin{pmatrix} -4.5 & -9.0 \\ -4.2 & -8.4 \end{pmatrix} \]

3.  **상태 전이 압력 `P` 계산**
    -   `P = <∂L/∂W, B_cos>`
        \[ P = (-4.5 \cdot 0.4) + (-9.0 \cdot 0.5) + (-4.2 \cdot 0.5) + (-8.4 \cdot 0.6) \]
        \[ P = (-1.8) + (-4.5) + (-2.1) + (-5.04) = -13.44 \]

4.  **상태 업데이트 결정**
    -   임계값 `τ`가 `5.0`이라고 가정하자.
    -   현재 압력 `P = -13.44`는 `-τ`보다 작다 (`-13.44 < -5.0`).
    -   이는 손실을 줄이기 위해 패턴이 `B_cos`의 반대 방향, 즉 `-B_cos`와 매우 유사해져야 함을 의미한다. `cos`의 다음 상태는 `-sin`이고 그 다음은 `-cos`이므로, 현재 상태에서 `-cos` 방향으로 강한 압력이 있음을 시사한다.
    -   규칙에 따라 `phase_state`를 **역방향으로** 변경해야 한다는 강한 신호이다. (`sin` -> `-cos` 또는 `cos` -> `sin`). 여기서는 `-cos` 상태(`11`)로의 전이를 고려할 수 있다.
    -   **결과**: `phase_state` 비트를 `00`에서 `11`로 업데이트하는 것을 고려하거나, 혹은 `00` -> `11` 로 한 번에 이동하는 규칙을 설계할 수 있다. 이 예제에서는 압력이 매우 강하므로, 상태를 `11`로 업데이트하기로 결정한다.

이 예제는 그래디언트라는 연속적인 정보가 어떻게 `hi` 필드의 이산적인 상태를 업데이트하는지에 대한 구체적인 메커니즘을 보여준다.

## 5.6. 요약

하이브리드 역전파는 단일 파라미터 내에 공존하는 두 세계-연속과 이산-를 각각의 언어로 소통하는 정교한 알고리즘이다.
-   **연속계 코어 (`lo`, `residuals`)**: 표준적인 미분과 경사 하강법을 통해 정밀하게 최적화된다.
-   **상태-전이 코어 (`hi`)**: 미분의 개념을 '상태 전이'로 확장하고, 그래디언트를 다음 상태로의 '압력'으로 해석하여 이산적인 비트 필드를 직접 업데이트한다.

이 두 메커니즘의 융합은, 기존 신경망이 도달할 수 없었던 수준의 압축률과 효율성을 유지하면서도 완전한 학습 가능성을 보장하는 본 패러다임의 수학적 근간을 이룬다. 